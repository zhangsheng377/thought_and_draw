import os

# os.environ["CUDA_VISIBLE_DEVICES"] = ""

import torch
from transformers import AutoTokenizer, AutoModelForCausalLM
from peft import PeftModel

model_path = "/mnt/nfs_fn/zsd_server/models/huggingface/Qwen3-4B"
lora_path = "./save_model"
# lora_path = "./save_model/checkpoint-2814"
device='auto'

tokenizer = AutoTokenizer.from_pretrained(lora_path)
model = AutoModelForCausalLM.from_pretrained(model_path, dtype=torch.bfloat16, device_map=device, )
model.resize_token_embeddings(len(tokenizer))
model = PeftModel.from_pretrained(model=model,
                                  model_id=lora_path,
                                  device_map=device,
                                  use_safetensors=True
                                  )
model = model.merge_and_unload()
for n, p in model.named_parameters():
    if p.device.type == "meta":
        print(f"{n} is on meta!")

label = 7
messages = [{
    "role": "user",
    "content": f"请画一个{label}",
}]
input_text = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
inputs = tokenizer(input_text, return_tensors="pt").to(model.device)

outputs = model.generate(
    **inputs,
    max_new_tokens=2048,
    do_sample=True,
    temperature=1.0,
    pad_token_id=tokenizer.eos_token_id,
)

# 解码完整响应
full_response = tokenizer.decode(outputs[0], skip_special_tokens=False)
print(full_response)

"""
<|im_start|>user
请画一个7<|im_end|>
<|im_start|>assistant
<think>
我需要画一个简单的数字"7"。它是一个黑色的数字，背景是白色的。字体可以用近似书写工具绘制的。图片非常简洁，没有其他背景元素或装饰。分辨率为28*28。
</think>

好的，这是一个简单的7图像：<|vision_start|>[PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255][PX255]<|vision_end|><|im_end|>
"""
